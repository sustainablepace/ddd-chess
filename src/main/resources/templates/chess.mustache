<html>
<head>
    <title>{{title}}</title>
    <link rel="stylesheet" href="/css/chessboard-1.0.0.min.css">
    <script src="/js/jquery-3.5.1.min.js"></script>
    <script src="/js/chessboard-1.0.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let div = 'myBoard';
            let chessGame = {
                id: "",
                board: Chessboard(div),
                turn: "",
                white: "",
                black: "",
                status: "InProgress",
                computerTurn: false
            }

            let onDragStart = function (source, piece) {
                if ((chessGame.turn === 'white' && piece.search(/^w/) === -1) ||
                        (chessGame.turn === 'black' && piece.search(/^b/) === -1)) {
                    return false
                }
            }

            let onDrop = function (departureSquare, arrivalSquare) {
                let game = makeMove(departureSquare, arrivalSquare)
                if (game === null) {
                    return "snapback"
                } else {
                    updateGame(game)
                    console.log(game)

                }
            }

            let makeMove = function (departureSquare, arrivalSquare) {
                let outcome = null
                $.ajax({
                    type: "post",
                    async: false,
                    url: "/move/" + chessGame.id,
                    data: departureSquare + "-" + arrivalSquare,
                    contentType: "text/plain",
                    success: function (game) {
                        outcome = game
                    }
                })
                return outcome
            }

            let suggestMove = function() {
                let outcome = null
                $.ajax({
                    type: "post",
                    async: false,
                    url: "/calculateMove/" + chessGame.id,
                    success: function (move) {
                        outcome = move
                    }
                })
                return outcome
            }

            $('#startBtn').on('click', function () {
                $.post("/setup", updateGame)
            })

            async function updateGame(game) {
                chessGame.id = game.id

                let draggable = !game.computerTurn && game.status === "InProgress"
                chessGame.board = Chessboard(div, {
                    onDrop: onDrop,
                    onDragStart: onDragStart,
                    draggable: draggable,
                    position: game.position
                })
                chessGame.turn = game.turn
                chessGame.white = game.white
                chessGame.black = game.black
                chessGame.status = game.status
                chessGame.computerTurn = game.computerTurn
                if (game.status !== "InProgress") {
                    alert("Game over - " + game.status)
                }

                if(chessGame.computerTurn && chessGame.status === "InProgress") {
                    let move = suggestMove()
                    await new Promise(r => setTimeout(r, 500));
                    if(move !== null) {
                        let squares = move.split("-")
                        onDrop(squares[0], squares[1])
                    }
                }
            }
        });
    </script>
</head>
<body>

<h1>{{title}}</h1>
<button id="startBtn">Start game</button>
<br/>
<br/>
<div id="myBoard" style="width: 400px"></div>

</body>
</html>